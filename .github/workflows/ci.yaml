# Copyright 2026 The OpenChoreo Authors
# SPDX-License-Identifier: Apache-2.0

name: Build Images and Release Charts

on:
  pull_request:
    types: [closed]
    branches: [main]
    paths:
      - "**/init/**"
      - "**/helm/Chart.yaml"
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build-images:
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    outputs:
      images-built: ${{ steps.build.outputs.images-built }}
      built-modules: ${{ steps.build.outputs.built-modules }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Install yq
        uses: mikefarah/yq@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Detect changes, build and push images
        id: build
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          UPDATED=false
          BUILT_MODULES=""

          # Determine changed files
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          else
            CHANGED_FILES=$(git ls-files)
          fi

          for dir in */; do
            module="${dir%/}"

            # Skip if no changes in this module's init/ directory (unless manually triggered)
            if [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
              if ! echo "$CHANGED_FILES" | grep -q "^${module}/init/"; then
                continue
              fi
            fi

            # Skip if no module.yaml exists
            if [ ! -f "${module}/module.yaml" ]; then
              echo "No module.yaml found for ${module}, skipping"
              continue
            fi

            image_count=$(yq '.images | length' "${module}/module.yaml")
            if [ "$image_count" = "0" ] || [ "$image_count" = "null" ]; then
              continue
            fi

            for i in $(seq 0 $((image_count - 1))); do
              image_name=$(yq ".images[${i}].name" "${module}/module.yaml")
              context=$(yq ".images[${i}].context" "${module}/module.yaml")
              dockerfile=$(yq ".images[${i}].dockerfile" "${module}/module.yaml")
              values_repo_path=$(yq ".images[${i}].valuesYaml.repositoryPath" "${module}/module.yaml")

              FULL_IMAGE="ghcr.io/${REPO_OWNER}/${image_name}"

              echo "::group::Building ${FULL_IMAGE}:${SHORT_SHA}"
              docker build \
                -t "${FULL_IMAGE}:${SHORT_SHA}" \
                -t "${FULL_IMAGE}:latest" \
                -f "${module}/${dockerfile}" \
                "${module}/${context}"

              docker push "${FULL_IMAGE}" --all-tags
              echo "::endgroup::"

              # Update image repository in values.yaml
              yq -i "${values_repo_path} = \"${FULL_IMAGE}\"" "${module}/helm/values.yaml"

              # Update appVersion in Chart.yaml (used as default image tag)
              yq -i ".appVersion = \"${SHORT_SHA}\"" "${module}/helm/Chart.yaml"
              UPDATED=true

              # Track which modules had images built
              if [ -z "$BUILT_MODULES" ]; then
                BUILT_MODULES="${module}"
              else
                BUILT_MODULES="${BUILT_MODULES},${module}"
              fi
            done
          done

          if [ "$UPDATED" = true ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add '*/helm/Chart.yaml' '*/helm/values.yaml'
            git diff --cached --quiet || git commit -m "ci: update image tags to ${SHORT_SHA} [skip ci]"
            git push
          fi

          echo "images-built=${UPDATED}" >> "$GITHUB_OUTPUT"
          echo "built-modules=${BUILT_MODULES}" >> "$GITHUB_OUTPUT"

  release-charts:
    needs: build-images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Pull the latest commit (may include the appVersion update from build-images)
          # fetch-depth: 3 ensures HEAD~2 exists for diffing when build-images pushed a commit
          ref: ${{ github.ref }}
          fetch-depth: 3

      - name: Pull latest changes
        run: git pull --ff-only origin ${{ github.ref_name }}

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Install yq
        uses: mikefarah/yq@v4

      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io --username "${{ github.actor }}" --password-stdin

      - name: Detect charts with version changes and publish
        env:
          BUILT_MODULES: ${{ needs.build-images.outputs.built-modules }}
        run: |
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')

          # Determine changed files in the original commit (before any bot commits)
          # If build-images pushed a commit, we need to look 2 commits back
          if [ "${{ needs.build-images.outputs.images-built }}" = "true" ]; then
            # HEAD is the bot commit, HEAD~1 is the user commit, HEAD~2 is the previous state
            CHANGED_FILES=$(git diff --name-only HEAD~2 HEAD~1)
          elif git rev-parse HEAD~1 >/dev/null 2>&1; then
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          else
            CHANGED_FILES=$(git ls-files)
          fi

          PUBLISHED=false

          for module_dir in */; do
            module="${module_dir%/}"
            chart_dir="${module}/helm"

            if [ ! -f "${chart_dir}/Chart.yaml" ]; then
              continue
            fi

            SHOULD_PUBLISH=false

            # Check if Chart.yaml version field was changed in this module
            if echo "$CHANGED_FILES" | grep -q "^${module}/helm/Chart.yaml"; then
              # Verify the 'version' field actually changed (not just appVersion)
              if [ "${{ needs.build-images.outputs.images-built }}" = "true" ]; then
                OLD_VERSION=$(git show HEAD~2:"${chart_dir}/Chart.yaml" 2>/dev/null | yq '.version' || echo "")
                NEW_VERSION=$(git show HEAD~1:"${chart_dir}/Chart.yaml" 2>/dev/null | yq '.version' || echo "")
              else
                OLD_VERSION=$(git show HEAD~1:"${chart_dir}/Chart.yaml" 2>/dev/null | yq '.version' || echo "")
                NEW_VERSION=$(yq '.version' "${chart_dir}/Chart.yaml")
              fi

              if [ "$OLD_VERSION" != "$NEW_VERSION" ] && [ -n "$NEW_VERSION" ]; then
                echo "Chart version changed for ${module}: ${OLD_VERSION} -> ${NEW_VERSION}"
                SHOULD_PUBLISH=true
              fi
            fi

            # For workflow_dispatch, publish all charts
            if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              SHOULD_PUBLISH=true
            fi

            if [ "$SHOULD_PUBLISH" != "true" ]; then
              echo "Skipping ${module}: no chart version change detected"
              continue
            fi

            chart_name=$(yq '.name' "${chart_dir}/Chart.yaml")
            chart_version=$(yq '.version' "${chart_dir}/Chart.yaml")

            echo "::group::${chart_name} v${chart_version}"

            # Add dependency repos and build
            dep_count=$(yq '.dependencies | length' "${chart_dir}/Chart.yaml")
            if [ "$dep_count" != "null" ] && [ "$dep_count" != "0" ]; then
              for i in $(seq 0 $((dep_count - 1))); do
                dep_repo=$(yq ".dependencies[${i}].repository" "${chart_dir}/Chart.yaml")
                if [ -n "$dep_repo" ] && [ "$dep_repo" != "null" ]; then
                  dep_name="dep-$(echo "$dep_repo" | md5sum | cut -d' ' -f1)"
                  helm repo add "$dep_name" "$dep_repo" 2>/dev/null || true
                fi
              done
              helm dependency build "${chart_dir}"
            fi

            helm package "${chart_dir}" -d .packages

            echo "Pushing ${chart_name}:${chart_version} to ghcr.io/${REPO_OWNER}/charts..."
            helm push ".packages/${chart_name}-${chart_version}.tgz" "oci://ghcr.io/${REPO_OWNER}/charts"

            PUBLISHED=true
            echo "::endgroup::"
          done

          if [ "$PUBLISHED" != "true" ]; then
            echo "No charts required publishing"
          fi
